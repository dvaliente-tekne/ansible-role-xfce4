#SPDX-License-Identifier: MIT-0
---
# tasks file for ./ansible-role-xfce4/

# =============================================================================
# Package Installation - All Hosts
# =============================================================================

- name: Install XFCE4 packages
  community.general.pacman:
    name: "{{ xfce4_packages }}"
    state: present
  register: xfce4_install_result
  tags:
    - xfce4
    - packages

# =============================================================================
# LightDM Installation - ASTER Only
# =============================================================================

- name: Install LightDM packages (ASTER only)
  community.general.pacman:
    name: "{{ xfce4_lightdm_packages }}"
    state: present
  register: lightdm_install_result
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - packages

- name: Enable LightDM service without starting (ASTER only)
  ansible.builtin.systemd:
    name: "{{ xfce4_lightdm_service }}"
    enabled: true
    state: stopped
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - service

# =============================================================================
# User Configuration
# =============================================================================

- name: Get user info for home directories
  ansible.builtin.getent:
    database: passwd
    key: "{{ item.name }}"
  loop: "{{ users }}"
  loop_control:
    label: "{{ item.name }}"
  register: user_info
  tags:
    - xfce4
    - config

- name: Create xdg-desktop-portal config directory for each user
  ansible.builtin.file:
    path: "{{ item.ansible_facts.getent_passwd[item.item.name][4] }}/.config/xdg-desktop-portal"
    state: directory
    owner: "{{ item.item.name }}"
    group: "{{ item.item.group | default(default_group) }}"
    mode: '0755'
  loop: "{{ user_info.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags:
    - xfce4
    - config

- name: Create themes directory for each user
  ansible.builtin.file:
    path: "{{ item.ansible_facts.getent_passwd[item.item.name][4] }}/.themes"
    state: directory
    owner: "{{ item.item.name }}"
    group: "{{ item.item.group | default(default_group) }}"
    mode: '0755'
  loop: "{{ user_info.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags:
    - xfce4
    - config
    - themes

- name: Extract minimal-grey2 theme for each user
  ansible.builtin.unarchive:
    src: 98942-minimal-grey2.tar
    dest: "{{ item.ansible_facts.getent_passwd[item.item.name][4] }}/.themes"
    owner: "{{ item.item.name }}"
    group: "{{ item.item.group | default(default_group) }}"
    creates: "{{ item.ansible_facts.getent_passwd[item.item.name][4] }}/.themes/Minimal-Grey2"
  loop: "{{ user_info.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags:
    - xfce4
    - config
    - themes

- name: Copy xfce-portals.conf for each user
  ansible.builtin.copy:
    src: xfce-portals.conf
    dest: "{{ item.ansible_facts.getent_passwd[item.item.name][4] }}/.config/xdg-desktop-portal/xfce-portals.conf"
    owner: "{{ item.item.name }}"
    group: "{{ item.item.group | default(default_group) }}"
    mode: '0644'
  loop: "{{ user_info.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags:
    - xfce4
    - config
    - portals

# =============================================================================
# System Configuration
# =============================================================================

- name: Copy gnome-keyring.portal to system portals directory
  ansible.builtin.copy:
    src: gnome-keyring.portal
    dest: /usr/share/xdg-desktop-portal/portals/gnome-keyring.portal
    owner: root
    group: root
    mode: '0644'
  tags:
    - xfce4
    - config
    - portals

- name: Copy ACPI handler script
  ansible.builtin.copy:
    src: handler.sh
    dest: /etc/acpi/handler.sh
    owner: root
    group: root
    mode: '0755'
  tags:
    - xfce4
    - config
    - acpi

# =============================================================================
# Verification - All Hosts
# =============================================================================

- name: Verify XFCE4 packages are installed
  ansible.builtin.command:
    cmd: "pacman -Q {{ item }}"
  loop: "{{ xfce4_packages }}"
  register: xfce4_package_verify
  changed_when: false
  failed_when: xfce4_package_verify.rc != 0
  tags:
    - xfce4
    - verify

- name: Display XFCE4 installation result
  ansible.builtin.debug:
    msg: "XFCE4 packages installed successfully: {{ xfce4_install_result is success }}"
  tags:
    - xfce4
    - verify

# =============================================================================
# Verification - ASTER Only
# =============================================================================

- name: Verify LightDM packages are installed (ASTER only)
  ansible.builtin.command:
    cmd: "pacman -Q {{ item }}"
  loop: "{{ xfce4_lightdm_packages }}"
  register: lightdm_package_verify
  changed_when: false
  failed_when: lightdm_package_verify.rc != 0
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - verify

- name: Check LightDM service is enabled (ASTER only)
  ansible.builtin.command:
    cmd: "systemctl is-enabled {{ xfce4_lightdm_service }}"
  register: lightdm_enabled_check
  changed_when: false
  failed_when: lightdm_enabled_check.rc != 0
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - verify

- name: Check LightDM service is not running (ASTER only)
  ansible.builtin.command:
    cmd: "systemctl is-active {{ xfce4_lightdm_service }}"
  register: lightdm_active_check
  changed_when: false
  failed_when: false
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - verify

- name: Display LightDM verification results (ASTER only)
  ansible.builtin.debug:
    msg: |
      LightDM Status on {{ hostname }}:
      ==================================
      Packages installed: {{ lightdm_install_result is success }}
      Service enabled: {{ lightdm_enabled_check.stdout | default('N/A') }}
      Service running: {{ lightdm_active_check.stdout | default('N/A') }} (should be 'inactive')
  when: hostname == xfce4_lightdm_hostname
  tags:
    - xfce4
    - lightdm
    - verify
